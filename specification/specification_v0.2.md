Devicetree Specification
===
Release v0.2

translated: 2018/02/14, by musashino205


# 目次
1. イントロダクション  
	1. 目的と範囲
	1. IEEE&trade; 1275及びePAPRとの関係
	1. 32-bit及び64-bitサポート
	1. 用語の定義

1. デバイスツリー
	1. 概要
	1. デバイスツリーの構造と規則
		1. ノード名
		1. 推奨される一般名
		1. パス名
		1. プロパティ
	1. 標準プロパティ
		1. compatible
		1. model
		1. phandle
		1. status
		1. #address-cells と #size-cells
		1. reg
		1. virtual-reg
		1. ranges
		1. dma-ranges
		1. name（非推奨）
		1. device_type（非推奨）
	1. 割り込みと割り込みマッピング
		1. 割り込みを発生させるデバイスのプロパティ
		1. 割り込みコントローラのプロパティ
		1. Interrupt Nexus Properties
		1. 割り込みマッピング例

1. デバイスノード要件
	1. ベースのデバイスノードタイプ
	1. ルートノード
	1. ```/aliases``` ノード
	1. ```/memory``` ノード
	1. ```/chosen``` ノード
	1. ```/cpus``` ノードプロパティ
	1. ```/cpus/cpu``` ノードプロパティ
		1. ```/cpus/cpu``` ノードの一般プロパティ
		1. TLBプロパティ
		1. 内部 (L1) キャッシュプロパティ
		1. 参考例
	1. マルチレベル/共有キャッシュノード (```/cpus/cpu*/l?-cache```)
		1. 参考例

1. デバイスのバインド
	1. バインドガイドライン
		1. 基本方針
		1. 多方面にわたるプロパティ
	1. シリアルデバイス
		1. シリアルクラスのバインド
		1. ナショナル セミコンダクター 16450/16550 互換 UART 要件
	1. ネットワークデバイス
		1. ネットワーククラスのバインド
		1. イーサネット定義の考慮事項
	1. Power ISA Open PIC 割り込みコントローラ
	1. ```simple-bus``` 互換値

1. Flattened Devicetree (DTB) フォーマット
	1. バージョン付け
	1. ヘッダ
	1. メモリ予約ブロック
		1. 目的
		1. 形式
	1. ストラクチャブロック
		1. 辞書的なストラクチャ
		1. ツリー構造
	1. 文字列ブロック
	1. アラインメント

1. Devicetree Source (DTS) フォーマット（バージョン 1）
	1. コンパイラディレクティブ
	1. ラベル
	1. ノードとプロパティの定義
	1. ファイルレイアウト


# チャプター1 イントロダクション
## 1.1 目的と範囲
コンピュータシステムの初期化とブートを行うには、様々なソフトウェアコンポーネントとやり取りします。ファームウェアは、コントロールがオペレーティングシステムやブートローダ、ハイパーバイザに渡されるまで、システムハードウェアの低レベルでの初期化を実行します。ブートローダやハイパーバイザは、順序の中でコントロールを読み込んだり、オペレーティングシステムに転送することができます。一般的に、一貫したインターフェースと規約はそれらのソフトウェアコンポーネント間のやり取りを容易にします。このドキュメントにおける用語 "ブートプログラム" は、一般的にシステム状態の初期化を行うこと、またその他の "クライアントプログラム" として参照されるソフトウェアコンポーネントの実行に使用されます。ブートプログラムに含まれるものの例: ファームウェアとブートローダ、ハイパーバイザ。クライアントプログラムに含まれるものの例: ブートローダ、ハイパーバイザ、オペレーティングシステム、特定の目的のプログラム。クライアントプログラムとブートプログラムのどちらでもある一部のプログラム（例: ハイパーバイザ）。

この "Devicetree Specification (DTSpec)は、ブートプログラムからクライアントプログラムへの完全なインターフェース定義を提供し、最低限のシステム要件を取りまとめて、幅広い種類のシステム開発を容易にします。

この仕様は、組込システムの要件をターゲットとしています。組込システムは一般的に、システムハードウェアとオペレーティングシステム、特定の処理を行うために設計されたアプリケーションソフトウェア、特定のタスクの組み合わせから成り立っています。これは通常用途のコンピュータとは異なり、様々なソフトウェアやI/Oデバイスを利用してユーザーによりカスタマイズされるように設計されています。その他組込システムに含まれると思われる特徴:

- アプリケーションのために可能な限り特化させた固定的なI/Oデバイスの組み合わせ
- サイズとコストに最適化されたシステムボード
- 限定的なユーザーインターフェース
- リソースへの制限（限定的なメモリや不揮発ストレージ）
- リアルタイム性の制限
- 幅広いオペレーティングシステムの使用（Linuxを含むリアルタイムオペレーティングシステムやカスタム、またはプロプライエタリなオペレーティングシステム）

## 1.2 IEEE&trade; 1275とePAPRとの関係
（後回し）

## 1.3 32-bit及び64-bitサポート
（後回し）

## 1.4 用語の定義
**AMP** Asymmetric Multiprocessing。コンピュータはグループに分けられた複数のCPUを利用でき、それぞれで別個のオペレーティングシステムイメージを実行します。それらのCPUは、同一であったり、または同一ではないかもしれません。

**ブートCPU (boot CPU)** ブートプログラムがクライアントプログラムのエントリポイントへ割り当てる、最初のCPUです。

**Book III-E** 組込環境。スーパーバイザインストラクションと、組込Powerプロセッサ実装で使用される関連機能を定義しているPower ISAのセクションです。

**ブートプログラム (boot program)** 一般的に、システム状態を初期化するソフトウェアコンポーネントの参照と、クライアントプログラムとして参照される他のソフトウェアコンポーネントを実行するために使用されます。ブートプログラムに含まれるものの例: ファームウェアとブートローダ、ハイパーバイザ。

**クライアントプログラム (client program)** アプリケーションやオペレーティングシステムソフトウェアの特徴を含むプログラムです。クライアントプログラムに含まれるものの例: ブートローダとハイパーバイザ、オペレーティングシステム、特定の目的のプログラム。

**セル (cell)** 32bitから成り立つ情報の単位

**DMA** Direct memory access

**DTB** Devicetree blob。デバイスツリーのコンパクトなバイナリによる表現。

**DTC** Devicetree compiler。DTSファイルからDTBファイルを作成するために使用される、オープンソースツールです。

**DTS** Devicetree syntax。DTCにより利用される、デバイスツリーのテキスト表現です。付録のDevicetree Source フォーマット（バージョン 1）を参照してください。

**effective address** プロセッサのストレージアクセスまたはブランチインストラクションにより操作されたメモリ上のアドレスです。

**物理アドレス (physical address)** プロセッサがメモリコントローラなどの外部デバイスにアクセスするために使用するアドレスです。

**Power ISA** Power Instruction Set Architecture

**interrupt specifier** 割込みを説明するプロパティ値です。一般的に、割込み番号とsensitivity、トリガのメカニズムが含まれます。

**セカンダリCPU (secondary CPU)** クライアントプログラムがセカンダリCPUとして相応しいと決定した、ブートCPU以外のCPUです。

**SMP** Symmetric multiprocessing。2つ以上の同一のCPUを持つコンピュータアーキテクチャは、メモリとIOを共有することができ、単一のオペレーティングシステム下で操作を行います。

**SoC** System on a chip。一つ以上のCPUと同数程度の周辺機器を統合した、単一のコンピュータチップです。

**unit address** 親ノードのアドレス空間に対するノードのアドレスを定義している、ノード名の一部です。

**quiescent CPU** 他のCPUの通常オペレーションによって干渉できない状態にある、または他の実行中のCPUの通常オペレーションによって、その状態を脱することができないCPUです。明示的なメソッドにより有効化、または再度有効化されることが期待されます。

# チャプター2 デバイスツリー
## 2.1 概要
（後回し）

## 2.2 デバイスツリーの構造と規則
### 2.2.1 ノード名
**ノード名要件**
デバイスツリーの各ノードは、下記規則に従って名づけられます:

```node-name@unit-address```  

*node-name* コンポーネントはノードの名前を定義します。これは1-31文字の長さで、表2.1内の文字の組み合わせからの文字のみで成り立つ必要があります。

表2.1: ノード名として有効な文字

|文字|説明|
|:--:|:--:|
|0-9|アラビア数字|
|a-z|アルファベット（小文字）|
|A-Z|アルファベット（大文字）|
|,|カンマ|
|.|ピリオド|
|_|アンダーバー（アンダースコア）|
|+|プラス記号|
|-|ダッシュ|

*node-name* は小文字または大文字のアルファベットから始まり、デバイスの一般クラスを説明する必要があります。

*unit-address* コンポーネントは、ノードが存在するバスタイプへの定義です。これは、表2.1内の文字から1文字以上のASCII文字で成り立ちます。unit-addressは、*reg* プロパティで定義されている最初のアドレスに一致していなければなりません。ノードが *reg* プロパティを持たない場合、*@unit-address* は除去したうえで、ツリーの同レベルにある他のノードからノードを区別しなければなりません。特定のバスに対するバインドを追加で定義する場合、*reg* と *unit-address* の形式の定義がさらに必要になります。

ルートノードは、ノード名やunit-addressを持ちません。スラッシュ (/) により識別されます。

<table style="text-align: center">
	<thead>
		<tr>
			<th>root</th>
			<th></th>
			<th></th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td rowspan=6>/</td>
			<td rowspan=2>cpus</td>
			<td>cpu@0</td>
		</tr>
		<tr>
			<td>cpu@1</td>
		</tr>
		<tr>
			<td>memory@0</td>
			<td></td>
		</tr>
		<tr>
			<td>uart@fe001000</td>
			<td></td>
		</tr>
		<tr>
			<td>ethernet@fe002000</td>
			<td></td>
		</tr>
		<tr>
			<td>ethernet@fe003000</td>
			<td></td>
		</tr>
	</tbody>
</table>
<legend>図2.2（表へ変換）: ノード名の例</legend>

図2.2中:
- ```cpu``` という名前のノードは、0と1のunit-addressの値で区別されています。
- ```ethernet``` という名前のノードは、```fe002000``` と ```fe003000``` のunit-addressの値で区別されています。

### 2.2.2 推奨される一般名
ノード名は、多少一般的で、デバイスの機能を反映し、プログラミングモデルに厳密ではないものにすべきです。使用する場合、名前は以下の選択肢のうちの一つになるべきです。

- adc
- accelerometer
- atm
- audio-codec
- audio-controller
- backlight
- bluetooth
- bus
- cache-controller
- camera
- can
- charger
- clock
- clock-controller
- compact-flash
- cpu
- cpus
- crypt
- disk
- display
- dma-controller
- dsp
- eeprom
- efuse
- endpoint
- ethernet
- ethernet-phy
- fdc
- flash
- gpio
- gpu
- gyrometer
- hdmi
- i2c
- ide
- interrupt-controller
- isa
- keyboard
- key
- keys
- lcd-controller
- light-sensor
- magnetometer
- mailbox
- mdio
- memory
- memory-controller
- mmc
- mmc-slot
- mouse
- nand-controller
- nvram
- oscillator
- parallel
- pc-card
- pci
- pcie
- phy
- pinctrl
- pmic
- pmu
- port
- ports
- pwm
- regulator
- reset-controller
- rtc
- sata
- scsi
- serial
- sound
- spi
- sram-controller
- ssi-controller
- syscon
- temperature-sensor
- timer
- touchscreen
- usb
- usb-hub
- usb-phy
- video-codec
- vme
- watchdog
- wifi

### 2.2.3 パス名
デバイスツリーのノードは、ルートノードから子ノードを通り、対象のノードへのフルパスを指定することで独自に識別されることができます。

デバイスパス指定の規則:  
```/node-name-1/node-name-2/node-name-N```

一例として、図2.2における cpu #1 へのデバイスパスは次の通りになります:  
```/cpus/cpu@1```

ルートノードへのパスは / です。
もしノードへのフルパスが不明瞭でない場合、unit-addressは記述しなくても問題ありません。
もしクライアントプログラムが不明瞭なパスに遭遇した場合、それに対する動作は未定義です。

### 2.2.4 プロパティ
デバイスツリーの各ノードは、ノードの特徴を説明するプロパティを持ちます。プロパティは、名前と値で成り立ちます。

#### プロパティ名
プロパティ名は、表2.2の文字から成る1～31文字の文字列です。

表2.2: プロパティ名として有効な文字

|文字|説明|
|:--:|:--:|
|0 - 9|整数|
|a - z|アルファベット（小文字）|
|A - Z|アルファベット（大文字）|
|,|カンマ|
|.|ピリオド|
|_|アンダーバー（アンダースコア）|
|+|プラス記号|
|?|クエスチョンマーク|
|#|ハッシュ記号|

非標準なプロパティ名は、プロパティを定義している企業または組織を識別する名前をユニークなプレフィクス文字列として含むべきです。例:

```fsl,channel-fifo-len```  
```ibm,ppc-interrupt-server#s```  
```linux,network-index```

#### プロパティ値
プロパティ値は、プロパティに結び付けられている情報を含む0以上の配列です。

プロパティは、true-false 情報を伝えている場合に空の値を持つことがあります。この場合、プロパティの存在・非存在は十分に表現されています。

表2.3は、DTSpecによる基本的な値の形式の定義の組み合わせを説明します。

表2.3: プロパティ値

|値|説明|
|:--:|:--|
|```<empty>```|値は空です。true-false情報を伝えるために使用され、この時プロパティ自身の存在・非存在を明確に表します。|
|```<u32>```|big-endian形式での32ビットintegerです。例: 32ビット値 0x11223344 は、メモリ上で以下の通りに表されます:<br /><br />```address   11```<br />```address+1 22```<br />```address+2 33```<br />```address+3 44```|
|```<u64>```|big-endian形式での64ビットintegerの表現です。2つの ```<u32>``` 値によって成り立ち、最初の値は特に重要なintegerのビットを、2つ目の値はそれ程重要ではないビットを含みます。<br />例: 64ビット値 0x1122334455667788 は、2つのセルで次の様に記述されます:<br />```<0x11223344 0x55667788>```<br />値は、メモリ上で以下の通りに表されます。<br /><br />```address   11```<br />```address+1 22```<br />```address+2 33```<br />```address+3 44```<br />```address+4 55```<br />```address+5 66```<br />```address+6 77```<br />```address+7 88```|
|```<string>```|printableかつnullで終端される文字列です。例: 文字列 "hello" は、メモリ上で以下の通りに表されます:<br /><br />```address 68 'h'```<br />```address+1 65 'e'```<br />```address+2 6C 'l'```<br />```address+3 6C 'l'```<br />```address+4 6F 'o'```<br />```address+5 00 '\0'```|
|```<prop-encoded-array>```|フォーマットはプロパティで指定されています。プロパティの定義を見てください。|
|```<phandle>```|```<u32>``` の値です。*phandle* 値は、デバイスツリー内の他のノードを参照する方法です。いずれのノードも、ユニークな ```<u32>``` 値によりphandleプロパティを定義して参照されることができます。数字は、phandle値形式でプロパティの値に使用されます。|
|```<stringlist>```|連結された ```<string>``` 値のリストです。<br />例: 文字列リスト "hello","world" は、メモリ上で以下の通りに表されます:<br /><br />```address 68 'h'```<br />```address+1 65 'e'```<br />```address+2 6C 'l'```<br />```address+3 6C 'l'```<br />```address+4 6F 'o'```<br />```address+5 00 '\0'```<br />```address+1 77 'w'```<br />```address+2 6F 'o'```<br />```address+3 72 'r'```<br />```address+4 6C 'l'```<br />```address+4 64 'd'```<br />```address+5 00 '\0'```|




